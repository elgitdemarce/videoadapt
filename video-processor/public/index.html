<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Procesador de Video Online</title>
    <link rel="stylesheet" href="/src/styles.css">
</head>
<body>
    <div class="container">
        <h1>Procesador de Video</h1>
        
        <div id="drop-zone" class="drop-zone">
            Arrastra y suelta archivos MP4 aquí
            <input type="file" id="file-input" accept="video/mp4" style="display:none;">
        </div>

        <div id="video-config" class="video-config" style="display:none;">
            <h2>Configuración de Procesamiento</h2>
            <div class="config-inputs">
                <label>Bitrate (kbps):
                    <input type="number" id="bitrate" value="2000" min="100" max="8000">
                </label>
                <label>FPS:
                    <input type="number" id="fps" value="30" min="1" max="60">
                </label>
                <label class="checkbox">
                    <input type="checkbox" id="keep-audio" checked> 
                    Mantener Audio
                </label>
            </div>
            <button id="process-btn">Procesar Video</button>
        </div>

        <div id="status" class="status"></div>
    </div>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
    <script>
        // Incluir script directamente para evitar problemas de carga
        document.addEventListener('DOMContentLoaded', () => {
            const { createFFmpeg, fetchFile } = FFmpeg;
            const ffmpeg = createFFmpeg({ log: true });

            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const videoConfig = document.getElementById('video-config');
            const statusDiv = document.getElementById('status');
            const processBtn = document.getElementById('process-btn');

            let currentFile = null;

            // Eventos de drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            dropZone.addEventListener('click', () => {
                fileInput.click();
            });

            dropZone.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFileSelect, false);

            function handleDrop(e) {
                const files = e.dataTransfer.files;
                handleFiles(files);
            }

            function handleFileSelect(e) {
                const files = e.target.files;
                handleFiles(files);
            }

            function handleFiles(files) {
                const mp4Files = [...files].filter(f => f.type === 'video/mp4');
                
                if (mp4Files.length > 0) {
                    currentFile = mp4Files[0];
                    dropZone.textContent = `Archivo seleccionado: ${currentFile.name}`;
                    videoConfig.style.display = 'block';
                } else {
                    statusDiv.textContent = 'Por favor, seleccione un archivo MP4';
                    dropZone.textContent = 'Arrastra y suelta archivos MP4 aquí';
                }
            }

            processBtn.addEventListener('click', async () => {
                if (!currentFile) {
                    statusDiv.textContent = 'Por favor, seleccione un archivo primero';
                    return;
                }

                const bitrate = document.getElementById('bitrate').value;
                const fps = document.getElementById('fps').value;
                const keepAudio = document.getElementById('keep-audio').checked;

                try {
                    statusDiv.textContent = 'Cargando FFmpeg...';
                    await ffmpeg.load();

                    statusDiv.textContent = 'Escribiendo archivo...';
                    ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(currentFile));

                    const ffmpegCommand = [
                        '-i', 'input.mp4',
                        '-c:v', 'libx264',
                        '-profile:v', 'high',
                        '-level', '4.0',
                        '-b:v', `${bitrate}k`,
                        '-r', fps,
                        keepAudio ? '' : '-an',
                        'output.mp4'
                    ].filter(Boolean);

                    statusDiv.textContent = 'Procesando video...';
                    await ffmpeg.run(...ffmpegCommand);

                    statusDiv.textContent = 'Generando archivo...';
                    const data = ffmpeg.FS('readFile', 'output.mp4');

                    const blob = new Blob([data.buffer], { type: 'video/mp4' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `processed_${currentFile.name}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    statusDiv.textContent = 'Procesamiento completado';
                } catch (error) {
                    console.error('Error de procesamiento:', error);
                    statusDiv.textContent = `Error: ${error.message}`;
                }
            });
        });
    </script>
</body>
</html>
