<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Procesador de Video</title>
    <!-- Encabezados de seguridad cruciales -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        #drop-zone {
            border: 3px dashed #3498db;
            border-radius: 20px;
            padding: 50px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        #drop-zone.drag-over {
            background-color: rgba(52, 152, 219, 0.1);
            border-color: #2980b9;
        }
        #video-config {
            display: none;
            margin-top: 20px;
        }
        .config-input {
            margin: 10px 0;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
        }
        .error-message {
            color: red;
            background-color: #ffeeee;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Procesador de Video</h1>
    
    <div id="compatibility-check" class="error-message" style="display:none;"></div>
    
    <div id="drop-zone">
        Arrastra y suelta archivos MP4 aquí
        <input type="file" id="file-input" accept="video/mp4" style="display:none;">
    </div>

    <div id="video-config">
        <div class="config-input">
            <label>Bitrate (kbps):</label>
            <input type="number" id="bitrate" value="2000" min="100" max="8000">
        </div>
        <div class="config-input">
            <label>FPS:</label>
            <input type="number" id="fps" value="30" min="1" max="60">
        </div>
        <div class="config-input">
            <label>
                <input type="checkbox" id="keep-audio" checked>
                Mantener Audio
            </label>
        </div>
        <button id="process-btn">Procesar Video</button>
    </div>

    <div id="status"></div>

    <script>
        // Función de verificación de compatibilidad
        function checkCompatibility() {
            const compatibilityCheck = document.getElementById('compatibility-check');
            const checks = [
                {
                    name: 'SharedArrayBuffer',
                    check: () => typeof SharedArrayBuffer !== 'undefined',
                    message: 'Su navegador no soporta SharedArrayBuffer. Actualice o use un navegador compatible.'
                },
                {
                    name: 'Cross-Origin Isolation',
                    check: () => window.crossOriginIsolated,
                    message: 'La página no está cross-origin isolated. Verifique los encabezados de seguridad.'
                },
                {
                    name: 'WebAssembly',
                    check: () => !!window.WebAssembly,
                    message: 'Su navegador no soporta WebAssembly.'
                }
            ];

            const failedChecks = checks.filter(check => !check.check());

            if (failedChecks.length > 0) {
                compatibilityCheck.style.display = 'block';
                compatibilityCheck.innerHTML = `
                    <strong>Problemas de Compatibilidad:</strong>
                    <ul>
                        ${failedChecks.map(check => `<li>${check.message}</li>`).join('')}
                    </ul>
                    <p>Soluciones posibles:</p>
                    <ul>
                        <li>Actualice su navegador a la última versión</li>
                        <li>Asegúrese de estar en un sitio HTTPS</li>
                        <li>Verifique la configuración de seguridad de su navegador</li>
                    </ul>
                `;
                return false;
            }

            compatibilityCheck.style.display = 'none';
            return true;
        }

        // Función para cargar FFmpeg de forma segura
        async function loadFFmpeg() {
            // Verificar compatibilidad
            if (!checkCompatibility()) {
                throw new Error('Entorno no compatible');
            }

            // Cargar script de FFmpeg
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js';
                
                script.onload = () => {
                    if (window.FFmpeg) {
                        const { createFFmpeg, fetchFile } = FFmpeg;
                        resolve({ createFFmpeg, fetchFile });
                    } else {
                        reject(new Error('No se pudo cargar FFmpeg'));
                    }
                };
                
                script.onerror = () => {
                    reject(new Error('Error al cargar script de FFmpeg'));
                };
                
                document.head.appendChild(script);
            });
        }

        // Elementos del DOM
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const videoConfig = document.getElementById('video-config');
        const processBtn = document.getElementById('process-btn');
        const statusDiv = document.getElementById('status');

        // Estado global
        let currentFile = null;

        // Configurar eventos de drag and drop
        function setupDragDropEvents() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            dropZone.addEventListener('dragenter', highlight, false);
            dropZone.addEventListener('dragover', highlight, false);
            dropZone.addEventListener('dragleave', unhighlight, false);
            dropZone.addEventListener('drop', handleDrop, false);

            // Soporte de clic
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            dropZone.classList.add('drag-over');
        }

        function unhighlight() {
            dropZone.classList.remove('drag-over');
        }

        function handleDrop(e) {
            unhighlight();
            const files = e.dataTransfer.files;
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            processFiles(files);
        }

        function processFiles(files) {
            const mp4Files = Array.from(files).filter(f => f.type === 'video/mp4');
            
            if (mp4Files.length > 0) {
                currentFile = mp4Files[0];
                dropZone.textContent = `Archivo seleccionado: ${currentFile.name}`;
                videoConfig.style.display = 'block';
                statusDiv.textContent = 'Archivo MP4 listo para procesar';
            } else {
                statusDiv.textContent = 'Por favor, seleccione un archivo MP4';
                dropZone.textContent = 'Arrastra y suelta archivos MP4 aquí';
            }
        }

        // Procesamiento de video
        processBtn.addEventListener('click', async () => {
            if (!currentFile) {
                statusDiv.textContent = 'Por favor, seleccione un archivo primero';
                return;
            }

            // Obtener configuraciones
            const bitrate = document.getElementById('bitrate').value;
            const fps = document.getElementById('fps').value;
            const keepAudio = document.getElementById('keep-audio').checked;

            try {
                // Cargar FFmpeg
                const { createFFmpeg, fetchFile } = await loadFFmpeg();
                const ffmpeg = createFFmpeg({ 
                    log: true,
                    // Configuraciones para mejor compatibilidad
                    corePath: 'https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js'
                });
                
                statusDiv.textContent = 'Cargando FFmpeg...';
                await ffmpeg.load();

                // Escribir archivo de entrada
                statusDiv.textContent = 'Escribiendo archivo...';
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(currentFile));

                // Construir comando FFmpeg
                const ffmpegCommand = [
                    '-i', 'input.mp4',
                    '-c:v', 'libx264',
                    '-profile:v', 'high',
                    '-level', '4.0',
                    '-b:v', `${bitrate}k`,
                    '-r', fps,
                    keepAudio ? '' : '-an',
                    'output.mp4'
                ].filter(Boolean);

                // Procesar video
                statusDiv.textContent = 'Procesando video...';
                await ffmpeg.run(...ffmpegCommand);

                // Leer archivo de salida
                statusDiv.textContent = 'Generando archivo...';
                const data = ffmpeg.FS('readFile', 'output.mp4');

                // Crear blob y descargar
                const blob = new Blob([data.buffer], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `processed_${currentFile.name}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                statusDiv.textContent = 'Procesamiento completado';

            } catch (error) {
                console.error('Error de procesamiento:', error);
                statusDiv.textContent = `Error: ${error.message}`;
            }
        });

        // Inicialización
        function init() {
            // Verificación inicial de compatibilidad
            checkCompatibility();
            setupDragDropEvents();
        }

        // Ejecutar inicialización
        init();
    </script>
</body>
</html>
